generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// RBAC SYSTEM
// ============================================

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  roleName    String   @unique @map("role_name") @db.VarChar(50)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id             String  @id @default(uuid()) @db.Uuid
  permissionName String  @unique @map("permission_name") @db.VarChar(100)
  resource       String  @db.VarChar(50)
  action         String  @db.VarChar(50)
  description    String? @db.Text

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid()) @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id           String   @id @default(uuid()) @db.Uuid
  phoneNumber  String?  @unique @map("phone_number") @db.VarChar(15)
  email        String?  @unique @db.VarChar(255)
  passwordHash String?  @map("password_hash") @db.VarChar(255)
  fullName     String   @map("full_name") @db.VarChar(255)
  isOnboarded  Boolean  @default(false) @map("is_onboarded")
  userType     UserType @default(student) @map("user_type")


  // Student-specific fields (nullable for non-students)
  creditBalance         Int     @default(0) @map("credit_balance")
  totalCreditsPurchased Int     @default(0) @map("total_credits_purchased")
  deviceFingerprint     String? @map("device_fingerprint") @db.VarChar(255)

  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamp(6)

  // Relations
  userRoles           UserRole[]
  examPreferences     UserExamPreference[]
  generatedPapers     GeneratedPaper[]
  paperAttempts       PaperAttempt[]
  creditTransactions  CreditTransaction[]
  uploadedContent     UploadedContent[]
  aiPromptTemplates   AiPromptTemplate[]
  systemConfigUpdates SystemConfig[]
  otpAttempts         OtpStorage[]

  @@index([phoneNumber])
  @@index([email])
  @@index([id, creditBalance])
  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  grantedAt DateTime @default(now()) @map("granted_at") @db.Timestamp(6)
  grantedBy String?  @map("granted_by") @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@map("user_roles")
}

model UserExamPreference {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  examId         String    @map("exam_id") @db.Uuid
  subjectId      String    @map("subject_id") @db.Uuid
  isPrimary      Boolean   @default(false) @map("is_primary")
  targetExamDate DateTime? @map("target_exam_date") @db.Date
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam Exam @relation(fields: [examId], references: [id])

  @@unique([userId, examId])
  @@index([userId, examId])
  @@map("user_exam_preferences")
}

// ============================================
// EXAM STRUCTURE
// ============================================

model Exam {
  id           String   @id @default(uuid()) @db.Uuid
  examCode     String   @unique @map("exam_code") @db.VarChar(50)
  examName     String   @map("exam_name") @db.VarChar(255)
  examFullName String?  @map("exam_full_name") @db.Text
  examBoard    String?  @map("exam_board") @db.VarChar(100)
  isActive     Boolean  @default(true) @map("is_active")
  isPopular    Boolean  @default(false) @map("is_popular")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  examSubjects        ExamSubject[]
  userExamPreferences UserExamPreference[]
  generatedPapers     GeneratedPaper[]
  uploadedContent     UploadedContent[]

  @@index([examCode])
  @@index([isPopular, isActive])
  @@map("exams")
}

// Base subject catalog (shared across exams)
model Subject {
  id          String  @id @default(uuid()) @db.Uuid
  subjectCode String  @unique @map("subject_code") @db.VarChar(50)
  subjectName String  @map("subject_name") @db.VarChar(255)
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  examSubjects    ExamSubject[]
  chapters        Chapter[]
  uploadedContent UploadedContent[]

  @@index([subjectCode])
  @@map("subjects")
}

// Many-to-many: Which subjects belong to which exams
model ExamSubject {
  id           String  @id @default(uuid()) @db.Uuid
  examId       String  @map("exam_id") @db.Uuid
  subjectId    String  @map("subject_id") @db.Uuid
  displayOrder Int?    @map("display_order")
  isActive     Boolean @default(true) @map("is_active")

  // Relations
  exam              Exam               @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject           Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  generatedPapers   GeneratedPaper[]
  aiPromptTemplates AiPromptTemplate[]

  @@unique([examId, subjectId])
  @@index([examId])
  @@index([subjectId])
  @@map("exam_subjects")
}

// Base chapter catalog (shared across subjects)
model Chapter {
  id          String  @id @default(uuid()) @db.Uuid
  subjectId   String  @map("subject_id") @db.Uuid
  chapterCode String  @map("chapter_code") @db.VarChar(50)
  chapterName String  @map("chapter_name") @db.VarChar(500)
  classId     String? @map("class_id") @db.Uuid
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  subject         Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  class           Class?            @relation(fields: [classId], references: [id])

  uploadedContent UploadedContent[]

  @@unique([subjectId, chapterCode])
  @@index([subjectId])
  @@index([classId])
  @@map("chapters")
}

// Exam-specific chapter configuration (weightage varies by exam)
// REMOVED SubjectChapter model


// Optional: Educational class/grade level (e.g., Class 11, Class 12)
model Class {
  id        String  @id @default(uuid()) @db.Uuid
  classCode String  @unique @map("class_code") @db.VarChar(20)
  className String  @map("class_name") @db.VarChar(100)
  isActive  Boolean @default(true) @map("is_active")

  // Relations
  chapters        Chapter[]
  uploadedContent UploadedContent[]

  @@map("classes")
}

// ============================================
// GENERATED PAPERS
// ============================================

model GeneratedPaper {
  id            String @id @default(uuid()) @db.Uuid
  userId        String @map("user_id") @db.Uuid
  examId        String @map("exam_id") @db.Uuid
  examSubjectId String @map("exam_subject_id") @db.Uuid

  paperTitle String? @map("paper_title") @db.VarChar(500)

  // Store ENTIRE AI-generated paper as JSON
  questionsData Json @map("questions_data") @db.JsonB
  // Format: [{ questionNumber, topicId, topicName, difficulty, questionType, questionText, options, correctAnswer, solution, marks, negativeMarks, estimatedTimeSeconds }]

  // Generation metadata
  selectedTopics         String[] @map("selected_topics") @db.Uuid
  difficultyDistribution Json     @map("difficulty_distribution") @db.JsonB
  totalQuestions         Int      @map("total_questions")
  maxMarks               Int      @map("max_marks")
  timeLimitMinutes       Int      @map("time_limit_minutes")

  // AI generation tracking
  aiPromptTemplateId  String? @map("ai_prompt_template_id") @db.Uuid
  aiPromptVersion     String? @map("ai_prompt_version") @db.VarChar(20)
  generationLatencyMs Int?    @map("generation_latency_ms")
  generationStatus    String  @map("generation_status") @db.VarChar(20)

  // Quality metrics
  studentRating Int?    @map("student_rating")
  isBookmarked  Boolean @default(false) @map("is_bookmarked")
  attemptCount  Int     @default(0) @map("attempt_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam             Exam              @relation(fields: [examId], references: [id])
  examSubject      ExamSubject       @relation(fields: [examSubjectId], references: [id])
  aiPromptTemplate AiPromptTemplate? @relation(fields: [aiPromptTemplateId], references: [id])
  paperAttempts    PaperAttempt[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([examId, examSubjectId])
  @@index([userId, isBookmarked])
  @@map("generated_papers")
}

// ============================================
// PAPER ATTEMPTS (Simplified with JSON)
// ============================================

model PaperAttempt {
  id      String @id @default(uuid()) @db.Uuid
  paperId String @map("paper_id") @db.Uuid
  userId  String @map("user_id") @db.Uuid

  attemptNumber Int @map("attempt_number")

  startedAt        DateTime  @default(now()) @map("started_at") @db.Timestamp(6)
  submittedAt      DateTime? @map("submitted_at") @db.Timestamp(6)
  timeTakenSeconds Int?      @map("time_taken_seconds")

  // Store ALL student answers as JSON
  answersData Json @map("answers_data") @db.JsonB
  // Format: [{ questionNumber, studentAnswer, isCorrect, timeSpent, marksAwarded }]

  // Calculated scores
  totalScore       Decimal? @map("total_score") @db.Decimal(6, 2)
  percentage       Decimal? @db.Decimal(5, 2)
  correctAnswers   Int?     @map("correct_answers")
  incorrectAnswers Int?     @map("incorrect_answers")
  unattempted      Int?

  // Rankings
  allTimeRank Int? @map("all_time_rank")
  cohortRank  Int? @map("cohort_rank")
  weeklyRank  Int? @map("weekly_rank")

  isCompleted Boolean @default(false) @map("is_completed")

  // Relations
  paper GeneratedPaper @relation(fields: [paperId], references: [id], onDelete: Cascade)
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, submittedAt(sort: Desc)])
  @@index([paperId, attemptNumber])
  @@index([userId, isCompleted])
  @@map("paper_attempts")
}

// ============================================
// CREDITS & TRANSACTIONS
// ============================================

model CreditTransaction {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid

  transactionType String @map("transaction_type") @db.VarChar(50)
  creditsChange   Int    @map("credits_change")
  balanceAfter    Int    @map("balance_after")

  // Payment details
  paymentGatewayId  String?  @map("payment_gateway_id") @db.VarChar(255)
  paymentAmountInr  Decimal? @map("payment_amount_inr") @db.Decimal(10, 2)
  paymentStatus     String?  @map("payment_status") @db.VarChar(50)
  razorpayPaymentId String?  @map("razorpay_payment_id") @db.VarChar(255)

  // Context
  relatedPaperId String? @map("related_paper_id") @db.Uuid

  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([paymentGatewayId])
  @@index([relatedPaperId])
  @@map("credit_transactions")
}

// ============================================
// PRICING CONFIGURATION
// ============================================

model PricingTier {
  id       String @id @default(uuid()) @db.Uuid
  tierName String @map("tier_name") @db.VarChar(50)
  tierCode String @unique @map("tier_code") @db.VarChar(20)

  priceInr     Decimal @map("price_inr") @db.Decimal(10, 2)
  credits      Int
  bonusCredits Int     @default(0) @map("bonus_credits")

  displayOrder Int?    @map("display_order")
  isActive     Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@map("pricing_tiers")
}

// ============================================
// AI CONFIGURATION
// ============================================

model AiPromptTemplate {
  id           String @id @default(uuid()) @db.Uuid
  templateName String @map("template_name") @db.VarChar(255)

  // Scope: per exam-subject combination
  scopeLevel    String  @map("scope_level") @db.VarChar(20)
  examSubjectId String? @map("exam_subject_id") @db.Uuid

  systemPrompt       String @map("system_prompt") @db.Text
  generationRules    Json   @map("generation_rules") @db.JsonB
  sampleOutputFormat Json?  @map("sample_output_format") @db.JsonB

  // A/B testing
  isActive Boolean @default(false) @map("is_active")
  version  Int     @default(1)

  // Performance metrics
  avgGenerationTimeMs Int?     @map("avg_generation_time_ms")
  avgStudentRating    Decimal? @map("avg_student_rating") @db.Decimal(3, 2)
  successRate         Decimal? @map("success_rate") @db.Decimal(5, 2)

  createdById String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  createdBy       User             @relation(fields: [createdById], references: [id])
  examSubject     ExamSubject?     @relation(fields: [examSubjectId], references: [id])
  generatedPapers GeneratedPaper[]

  @@index([scopeLevel, examSubjectId])
  @@index([isActive, scopeLevel])
  @@map("ai_prompt_templates")
}

model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  configKey   String   @unique @map("config_key") @db.VarChar(255)
  configValue Json     @map("config_value") @db.JsonB
  description String?  @db.Text
  updatedById String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  updatedBy User? @relation(fields: [updatedById], references: [id])

  @@map("system_config")
}

// ============================================
// CONTENT MANAGEMENT
// ============================================

model UploadedContent {
  id        String  @id @default(uuid()) @db.Uuid
  examId    String? @map("exam_id") @db.Uuid
  subjectId String? @map("subject_id") @db.Uuid
  chapterId String? @map("chapter_id") @db.Uuid
  classId   String? @map("class_id") @db.Uuid

  fileName      String  @map("file_name") @db.VarChar(500)
  fileType      String? @map("file_type") @db.VarChar(50)
  s3Bucket      String? @map("s3_bucket") @db.VarChar(255)
  s3Key         String? @map("s3_key") @db.VarChar(500)
  fileSizeBytes BigInt? @map("file_size_bytes")

  // Vectorization status
  vectorizationStatus      String    @map("vectorization_status") @db.VarChar(50)
  vectorizationStartedAt   DateTime? @map("vectorization_started_at") @db.Timestamp(6)
  vectorizationCompletedAt DateTime? @map("vectorization_completed_at") @db.Timestamp(6)
  questionsExtracted       Int       @default(0) @map("questions_extracted")

  uploadedById String   @map("uploaded_by") @db.Uuid
  uploadedAt   DateTime @default(now()) @map("uploaded_at") @db.Timestamp(6)

  // Relations
  exam       Exam?    @relation(fields: [examId], references: [id])
  subject    Subject? @relation(fields: [subjectId], references: [id])
  chapter    Chapter? @relation(fields: [chapterId], references: [id])
  class      Class?   @relation(fields: [classId], references: [id])
  uploadedBy User     @relation(fields: [uploadedById], references: [id])

  @@index([vectorizationStatus])
  @@index([chapterId])
  @@index([classId])
  @@map("uploaded_content")
}

// ============================================
// ANALYTICS & METRICS
// ============================================

model DailyMetric {
  id         String   @id @default(uuid()) @db.Uuid
  metricDate DateTime @unique @map("metric_date") @db.Date

  // User metrics
  newSignups  Int @default(0) @map("new_signups")
  activeUsers Int @default(0) @map("active_users")

  // Paper metrics
  papersGenerated         Int  @default(0) @map("papers_generated")
  papersAttempted         Int  @default(0) @map("papers_attempted")
  paperGenerationFailures Int  @default(0) @map("paper_generation_failures")
  avgGenerationTimeMs     Int? @map("avg_generation_time_ms")

  // Credit metrics
  creditsPurchased Int     @default(0) @map("credits_purchased")
  creditsConsumed  Int     @default(0) @map("credits_consumed")
  totalRevenueInr  Decimal @default(0) @map("total_revenue_inr") @db.Decimal(12, 2)

  // AI metrics
  avgPaperRating       Decimal? @map("avg_paper_rating") @db.Decimal(3, 2)
  questionErrorReports Int      @default(0) @map("question_error_reports")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([metricDate(sort: Desc)])
  @@map("daily_metrics")
}

// ============================================
// ENUMS (for validation reference)
// ============================================

enum QuestionType {
  MCQ_single
  MCQ_multiple
  Numerical
  Assertion_Reason
}

enum Difficulty {
  easy
  medium
  hard
}

enum StrengthRating {
  weak
  moderate
  strong
}

enum TransactionType {
  purchase
  referral_earned
  referral_bonus
  admin_grant
  paper_generation
  refund
}

enum ErrorType {
  incorrect_answer
  unclear_question
  wrong_solution
  formatting_issue
}

enum ReportStatus {
  pending
  reviewed
  fixed
  rejected
}

enum GenerationStatus {
  success
  failed
  partial
}

enum VectorizationStatus {
  pending
  processing
  completed
  failed
}

enum AdminRole {
  super_admin
  content_manager
  support
}

enum ScopeLevel {
  exam
  subject
  global
}

enum UserType {
  student
  admin
  content_manager
  support
}

// ============================================
// ADMIN INVITATIONS
// ============================================

model AdminTeamInvite {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique @db.VarChar(255)
  role      UserType
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamp(6)
  invitedBy String   @map("invited_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("admin_team_invites")
}

// ============================================
// OTP STORAGE
// ============================================

model OtpStorage {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  channel   String   @db.VarChar(20)
  codeHash  String   @map("code_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamp(6)
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel])
  @@index([userId])
  @@index([expiresAt])
  @@map("otp_storage")
}

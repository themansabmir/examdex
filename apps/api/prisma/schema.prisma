generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// RBAC SYSTEM (Configurable via Dashboard)
// ==========================================

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]
  users           User[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid())
  slug        String  @unique
  description String?

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@map("role_permissions")
}

// ==========================================
// CORE AUTH & IDENTITY (PHASE 0)
// ==========================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String?  @unique
  passwordHash String?  @map("password_hash")
  roleId       String   @map("role")
  status       String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  role                Role                  @relation(fields: [roleId], references: [id])
  otpRequests         OtpRequest[]
  student             Student?
  knowledgeSources    KnowledgeSource[]
  aiUsageLogs         AiUsageLog[]
  auditLogs           AuditLog[]

  @@map("users")
}

model OtpRequest {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  otpCode    String    @map("otp_code")
  channel    String
  expiresAt  DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_requests")
}

model AdminTeamInvite {
  id         String    @id @default(uuid())
  email      String
  role       String
  token      String
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("admin_team_invites")
}

// ==========================================
// STUDENT PROFILES (PHASE 3)
// ==========================================

model Student {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  targetExamId         String   @map("target_exam_id")
  onboardingCompleted  Boolean  @map("onboarding_completed")
  createdAt            DateTime @default(now()) @map("created_at")

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetExam      Exam              @relation(fields: [targetExamId], references: [id])
  profile         StudentProfile?
  tests           Test[]
  studentAnswers  StudentAnswer[]
  rankings        Ranking[]
  creditWallet    CreditWallet?
  purchases       Purchase[]

  @@map("students")
}

model StudentProfile {
  id        String   @id @default(uuid())
  studentId String   @unique @map("student_id")
  examYear  Int      @map("exam_year")
  goalScore Int      @map("goal_score")
  createdAt DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

// ==========================================
// EXAM & CURRICULUM (PHASE 0)
// ==========================================

model Exam {
  id        String   @id @default(uuid())
  name      String
  status    String
  createdAt DateTime @default(now()) @map("created_at")

  examSubjects ExamSubject[]
  students     Student[]
  tests        Test[]
  rankings     Ranking[]

  @@map("exams")
}

model Subject {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  topics           Topic[]
  examSubjects     ExamSubject[]
  knowledgeSources KnowledgeSource[]
  promptTemplates  PromptTemplate[]
  questions        Question[]
  rankings         Ranking[]

  @@map("subjects")
}

model Topic {
  id        String   @id @default(uuid())
  subjectId String   @map("subject_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  subject   Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions Question[]

  @@map("topics")
}

model ExamSubject {
  id        String @id @default(uuid())
  examId    String @map("exam_id")
  subjectId String @map("subject_id")

  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("exam_subjects")
}

// ==========================================
// KNOWLEDGE BASE & AI CONFIG (PHASE 1)
// ==========================================

model KnowledgeSource {
  id           String   @id @default(uuid())
  subjectId    String   @map("subject_id")
  title        String
  description  String?
  sourceType   String   @map("source_type")
  s3Bucket     String   @map("s3_bucket")
  s3Key        String   @map("s3_key")
  fileChecksum String   @map("file_checksum")
  version      Int
  status       String
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  subject            Subject               @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  creator            User                  @relation(fields: [createdBy], references: [id])
  knowledgeIndexJobs KnowledgeIndexJob[]

  @@map("knowledge_sources")
}

model KnowledgeIndexJob {
  id                  String    @id @default(uuid())
  knowledgeSourceId   String    @map("knowledge_source_id")
  vectorDb            String    @map("vector_db")
  embeddingModel      String    @map("embedding_model")
  chunkSize           Int       @map("chunk_size")
  overlap             Int
  status              String
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")

  knowledgeSource KnowledgeSource @relation(fields: [knowledgeSourceId], references: [id], onDelete: Cascade)

  @@map("knowledge_index_jobs")
}

model AiModel {
  id        String   @id @default(uuid())
  provider  String
  modelName String   @map("model_name")
  maxTokens Int      @map("max_tokens")
  createdAt DateTime @default(now()) @map("created_at")

  aiUsageLogs AiUsageLog[]

  @@map("ai_models")
}

model PromptTemplate {
  id           String   @id @default(uuid())
  subjectId    String   @map("subject_id")
  difficulty   String
  questionType String   @map("question_type")
  template     String
  version      Int
  isActive     Boolean  @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("prompt_templates")
}

model AiUsageLog {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  modelId     String   @map("model_id")
  tokensUsed  Int      @map("tokens_used")
  purpose     String
  referenceId String   @map("reference_id")
  createdAt   DateTime @default(now()) @map("created_at")

  user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  model AiModel @relation(fields: [modelId], references: [id])

  @@map("ai_usage_logs")
}

// ==========================================
// QUESTIONS & TESTS (PHASE 1 & 3)
// ==========================================

model Question {
  id             String   @id @default(uuid())
  subjectId      String   @map("subject_id")
  topicId        String   @map("topic_id")
  difficulty     String
  questionText   String   @map("question_text")
  options        Json
  correctAnswer  String   @map("correct_answer")
  explanation    String?
  source         String
  createdAt      DateTime @default(now()) @map("created_at")

  subject       Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic         Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  testQuestions TestQuestion[]

  @@map("questions")
}

model Test {
  id         String   @id @default(uuid())
  studentId  String   @map("student_id")
  examId     String   @map("exam_id")
  difficulty String
  status     String
  createdAt  DateTime @default(now()) @map("created_at")

  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam          Exam           @relation(fields: [examId], references: [id])
  testQuestions TestQuestion[]
  testResult    TestResult?

  @@map("tests")
}

model TestQuestion {
  id         String @id @default(uuid())
  testId     String @map("test_id")
  questionId String @map("question_id")
  sequence   Int

  test           Test            @relation(fields: [testId], references: [id], onDelete: Cascade)
  question       Question        @relation(fields: [questionId], references: [id])
  studentAnswers StudentAnswer[]

  @@map("test_questions")
}

model StudentAnswer {
  id               String   @id @default(uuid())
  testQuestionId   String   @map("test_question_id")
  studentId        String   @map("student_id")
  selectedAnswer   String   @map("selected_answer")
  isCorrect        Boolean  @map("is_correct")
  timeSpentSeconds Int      @map("time_spent_seconds")
  createdAt        DateTime @default(now()) @map("created_at")

  testQuestion TestQuestion @relation(fields: [testQuestionId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_answers")
}

// ==========================================
// ANALYTICS & ECONOMY (PHASE 2 & 3)
// ==========================================

model TestResult {
  id              String   @id @default(uuid())
  testId          String   @unique @map("test_id")
  totalQuestions  Int      @map("total_questions")
  correctAnswers  Int      @map("correct_answers")
  score           Int
  percentile      Float
  createdAt       DateTime @default(now()) @map("created_at")

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

model Ranking {
  id           String   @id @default(uuid())
  examId       String   @map("exam_id")
  subjectId    String   @map("subject_id")
  studentId    String   @map("student_id")
  rank         Int
  score        Int
  calculatedAt DateTime @map("calculated_at")

  exam    Exam    @relation(fields: [examId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("rankings")
}

model CreditWallet {
  id        String   @id @default(uuid())
  studentId String   @unique @map("student_id")
  balance   Int
  updatedAt DateTime @updatedAt @map("updated_at")

  student             Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  creditTransactions  CreditTransaction[]

  @@map("credit_wallets")
}

model CreditTransaction {
  id        String   @id @default(uuid())
  walletId  String   @map("wallet_id")
  change    Int
  reason    String
  createdAt DateTime @default(now()) @map("created_at")

  wallet CreditWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
}

model Package {
  id       String  @id @default(uuid())
  name     String
  credits  Int
  price    Decimal
  currency String
  isActive Boolean @map("is_active")

  purchases Purchase[]

  @@map("packages")
}

model Purchase {
  id        String   @id @default(uuid())
  studentId String   @map("student_id")
  packageId String   @map("package_id")
  amount    Decimal
  status    String
  createdAt DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id])

  @@map("purchases")
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String   @map("actor_user_id")
  action      String
  entity      String
  entityId    String   @map("entity_id")
  createdAt   DateTime @default(now()) @map("created_at")

  actor User @relation(fields: [actorUserId], references: [id])

  @@map("audit_logs")
}
